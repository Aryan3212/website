---
interface Props {
	src: string
	alt?: string
	height?: string
}

const { src, alt = 'Zoomable image', height = '500px' } = Astro.props
---

<div
	class='pan-zoom-container'
	style={`height: ${height}; overflow: hidden; border: 1px solid #e5e7eb; border-radius: 8px; cursor: grab; position: relative; display: flex; align-items: center; justify-content: center;`}
>
	<img
		src={src}
		alt={alt}
		class='pan-zoom-img'
		style='transform-origin: center center; max-width: 100%; max-height: 100%; object-fit: contain; pointer-events: none;'
	/>
	<div
		style='position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;'
	>
		Scroll to zoom Â· Drag to pan
	</div>
</div>

<script>
	function initPanZoom() {
		document.querySelectorAll('.pan-zoom-container').forEach((container) => {
			const img = container.querySelector('.pan-zoom-img') as HTMLImageElement
			if (!img || container.getAttribute('data-initialized')) return
			container.setAttribute('data-initialized', 'true')

			let scale = 1,
				panX = 0,
				panY = 0,
				isDragging = false,
				startX = 0,
				startY = 0

			const updateTransform = () => {
				img.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`
			}

			container.addEventListener(
				'wheel',
				(e: Event) => {
					const we = e as WheelEvent
					we.preventDefault()
					const delta = we.deltaY > 0 ? 0.9 : 1.1
					const newScale = Math.min(Math.max(0.5, scale * delta), 5)

					// Zoom toward mouse position
					const rect = container.getBoundingClientRect()
					const mouseX = we.clientX - rect.left - rect.width / 2
					const mouseY = we.clientY - rect.top - rect.height / 2

					panX = mouseX - (mouseX - panX) * (newScale / scale)
					panY = mouseY - (mouseY - panY) * (newScale / scale)
					scale = newScale

					updateTransform()
				},
				{ passive: false }
			)

			container.addEventListener('mousedown', (e: Event) => {
				const me = e as MouseEvent
				isDragging = true
				startX = me.clientX - panX
				startY = me.clientY - panY
				;(container as HTMLElement).style.cursor = 'grabbing'
			})

			document.addEventListener('mousemove', (e: MouseEvent) => {
				if (!isDragging) return
				panX = e.clientX - startX
				panY = e.clientY - startY
				updateTransform()
			})

			document.addEventListener('mouseup', () => {
				isDragging = false
				;(container as HTMLElement).style.cursor = 'grab'
			})
		})
	}
	initPanZoom()
	document.addEventListener('astro:after-swap', initPanZoom)
</script>
